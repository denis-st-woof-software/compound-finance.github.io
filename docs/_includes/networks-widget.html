<style type="text/css">
  #networks-widget-container {
    display: block;
    margin-top: 32px;
    max-width: 100%;
  }

  .networks-widget {
    overflow-x: auto;
  }

  .networks-widget .network-tabs {
    width: 100%;
    margin: 10px 0px 22px 0px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    padding: 10px 12px;
    background: linear-gradient(180deg, #F7F9FB 0%, #F2F4F7 100%);
    border: 1px solid #E5E8EB;
    border-radius: 16px;
    box-shadow: 0 6px 16px rgba(0,0,0,0.05);
  }

  .networks-widget .network-tabs .network-tab-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 9px 16px;
    user-select: none;
    cursor: pointer;
    font-weight: 700;
    font-size: 14px;
    line-height: 20px;
    color: #4B5B6B;
    border: 1px solid #E0E5EA;
    border-radius: 12px;
    background: #fff;
    transition: all 0.15s ease;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    white-space: nowrap;
  }

  .networks-widget .network-tabs .network-tab-button:hover {
    border-color: #C8D2DC;
    color: #141E27;
    transform: translateY(-1px);
  }

  .networks-widget .network-tabs .network-tab-button.active {
    color: #fff;
    background: linear-gradient(135deg, #141E27, #1F2A34);
    border-color: #141E27;
    box-shadow: 0 3px 8px rgba(0,0,0,0.12);
  }

  .networks-widget .network-tab-content-container {
    overflow-x: auto;
  }

  .networks-widget .network-tab-content {
    display: none;
  }

  .networks-widget .network-tab-content.active {
    display: block;
    padding: 10px 4px 32px 4px;
  }

  .copy-tool {
    display: block;
  }

  .copy-tool > div {
    display: inline-block;
    color: #141E27;
    vertical-align: middle;
    text-align: right;
  }

  .copy-tool .copy-button {
    width: 16px;
    height: 16px;
    margin: 0px;
    background: url('{{ "/public/img/icn-copy.svg" | relative_url }}');
    background-repeat: no-repeat;
    background-size: contain;
    background-position: center;
    display: block;
  }

  .copy-tool .copy-button:hover {
    background: url('{{ "/public/img/icn-copy-green.svg" | relative_url }}');
    cursor: pointer;
  }

  .copy-tool .blockscan-button {
    width: 16px;
    height: 16px;
    margin: 0px 4px;
    background: url('{{ "/public/img/icn-external-link.svg" | relative_url }}');
    background-repeat: no-repeat;
    background-size: contain;
    background-position: center;
    display: block;
  }

  .copy-tool .blockscan-button:hover {
    background: url('{{ "/public/img/icn-external-link-green.svg" | relative_url }}');
  }

  .copy-tool a {
    display: inline-block;
  }

  .card-layout {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: 14px;
    margin-top: 12px;
  }

  .asset-card, .protocol-card {
    background: #fff;
    border: 1px solid #E5E8EB;
    border-radius: 12px;
    padding: 14px 16px;
    box-shadow: 0px 2px 4px rgba(0,0,0,0.04);
  }

  .asset-card .card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    margin-bottom: 10px;
  }

  .asset-card .left {
    display: flex;
    align-items: center;
    gap: 10px;
    min-width: 0;
  }

  .asset-title {
    display: flex;
    flex-direction: column;
    gap: 2px;
    min-width: 0;
  }

  .asset-name {
    font-weight: 700;
    color: #141E27;
    font-size: 16px;
    line-height: 20px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .asset-address {
    color: #5B7083;
    font-size: 13px;
    line-height: 16px;
  }

  .card-actions {
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .pill {
    background: #F1F4F6;
    color: #5B7083;
    border-radius: 10px;
    padding: 4px 8px;
    font-size: 12px;
    line-height: 14px;
  }

  .metric-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 12px;
    margin: 10px 0 6px 0;
  }

  .metric {
    background: #F7F9FA;
    border-radius: 10px;
    padding: 10px 12px;
    display: flex;
    flex-direction: column;
    gap: 6px;
    min-height: 120px;
  }

  .metric .label {
    color: #5B7083;
    font-size: 12px;
    margin-bottom: 6px;
  }

  .metric .value {
    color: #141E27;
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 6px;
  }

  .metric .raw {
    color: #5B7083;
    font-size: 11px;
    line-height: 14px;
    white-space: normal;
    word-break: break-word;
    min-height: 14px;
  }

  .metric .bar {
    height: 6px;
    background: #E6EDF2;
    border-radius: 6px;
    overflow: hidden;
    margin-top: 4px;
  }

  .metric .bar > div {
    height: 100%;
    background: linear-gradient(90deg, #0BA360, #3CBA92);
  }

  .metric .bar.placeholder {
    background: #E6EDF2;
    opacity: 0.45;
  }

  .meta-list {
    margin-top: 10px;
    border-top: 1px solid #E5E8EB;
    padding-top: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .meta-item {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: nowrap;
  }

  .meta-key {
    min-width: 120px;
    color: #5B7083;
    font-weight: 700;
    font-size: 13px;
  }

  .meta-value {
    color: #141E27;
    font-size: 14px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1;
  }

  .meta-actions {
    display: inline-flex;
    gap: 6px;
    margin-left: 6px;
    flex-shrink: 0;
  }

  .protocol-card h5 {
    margin: 0 0 8px 0;
    font-size: 15px;
    color: #141E27;
  }

  .protocol-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 8px;
  }

  .protocol-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 12px;
    border: 1px solid #E5E8EB;
    border-radius: 10px;
    background: #FDFEFE;
  }

  .protocol-item .name {
    font-weight: 600;
    color: #141E27;
    font-size: 14px;
    margin-bottom: 2px;
  }

  .protocol-item .addr {
    color: #5B7083;
    font-size: 12px;
  }

  .protocol-item .actions {
    display: inline-flex;
    gap: 6px;
    align-items: center;
    flex-shrink: 0;
    margin-left: 12px;
  }

  @media (max-width: 640px) {
    .metric-grid {
      grid-template-columns: 1fr;
    }
    .card-layout {
      grid-template-columns: 1fr;
    }
  }
</style>

<template id="address-copy-button-template">
  <div class="copy-tool">
    <div class="copy-button" data-copy-text="0x000" title="Copy"></div>
  </div>
</template>

<template id="address-copy-link-template">
  <div class="copy-tool">
    <a target="_blank" href="#">
      <div title="View on block explorer" class="blockscan-button"></div>
    </a>
  </div>
</template>

<script type="text/javascript">
  document.addEventListener('DOMContentLoaded', () => {
    /* Build cards + copy tools for each protocol deployment using data from the markdown front matter */
    const deploymentsContainer = document.getElementById('networks-widget-container');
    const copyButtonTemplate = document.getElementById('address-copy-button-template');
    const copyLinkTemplate = document.getElementById('address-copy-link-template');

    if (!deploymentsContainer) return;

    let deploymentsObject = {};
    try {
      deploymentsObject = JSON.parse(('{{ page.deployments }}').replace(/=>/g, ':'));
    } catch (e) {
      console.error(e);
    }

    const deployments = Object.keys(deploymentsObject);
    const networksWidget = document.createElement('div');
    networksWidget.classList.add('networks-widget');

    const networkTabs = document.createElement('div');
    networkTabs.classList.add('network-tabs');
    networkTabs.id = 'network-tabs';

    const networkTabContainer = document.createElement('div');
    networkTabContainer.classList.add('network-tab-content-container');
    const activeClass = 'active';

    const tabClickHandler = (buttonIndex) => {
      const networkTabsContainer = document.getElementById('network-tabs');
      const tabContentContainers = document.getElementsByClassName('network-tab-content');
      const target = networkTabsContainer.children[buttonIndex];
      const numTabs = networkTabsContainer.children.length;
      for (let j = 0; j < numTabs; j++) {
        networkTabsContainer.children[j].classList.remove(activeClass);
        tabContentContainers[j].classList.remove(activeClass);
      }
      target.classList.add(activeClass);
      const tabContent = document.getElementById('network-tab-' + target.dataset.index);
      tabContent.classList.add(activeClass);
    };

    const truncateAddress = (addr) => {
      if (!addr || addr.length < 12) return addr || '';
      return addr.slice(0, 6) + '…' + addr.slice(-4);
    };

    const normalizeContractEntry = (contractValue, blockscanOrigin) => {
      const isObject = contractValue && typeof contractValue === 'object';
      const address = typeof contractValue === 'string'
        ? contractValue
        : isObject
          ? contractValue.address
          : '';

      const meta = isObject
        ? Object.entries(contractValue).filter(([ key ]) => key !== 'address')
        : [];

      return {
        address: address || '',
        explorerHref: address && blockscanOrigin ? blockscanOrigin + 'address/' + address : '',
        meta
      };
    };

    const createCopyButton = (text) => {
      const button = copyButtonTemplate.content.cloneNode(true);
      button.children[0].children[0].dataset.copyText = text;
      return button;
    };

    const createExplorerLink = (href) => {
      const link = copyLinkTemplate.content.cloneNode(true);
      link.children[0].children[0].href = href;
      return link;
    };

    const percentWidth = (value) => {
      const numeric = parseFloat(String(value).replace('%', ''));
      if (Number.isNaN(numeric)) return 0;
      return Math.max(0, Math.min(100, numeric));
    };

    const buildMetric = (label, value, raw, isPercent = false) => {
      const metric = document.createElement('div');
      metric.classList.add('metric');

      const lbl = document.createElement('div');
      lbl.classList.add('label');
      lbl.innerText = label;
      metric.appendChild(lbl);

      const val = document.createElement('div');
      val.classList.add('value');
      val.innerText = value || '—';
      metric.appendChild(val);

      const bar = document.createElement('div');
      bar.classList.add('bar');
      if (isPercent) {
        const fill = document.createElement('div');
        fill.style.width = percentWidth(value) + '%';
        bar.appendChild(fill);
      } else {
        bar.classList.add('placeholder');
      }
      metric.appendChild(bar);

      const rawEl = document.createElement('div');
      rawEl.classList.add('raw');
      const hasRaw = raw !== undefined && raw !== null && raw !== '';
      rawEl.innerText = `Raw: ${hasRaw ? raw : '—'}`;
      if (hasRaw) rawEl.title = raw;
      metric.appendChild(rawEl);

      return metric;
    };

    const buildMetaList = (metaEntries, blockscanOrigin) => {
      if (!metaEntries.length) return null;
      const container = document.createElement('div');
      container.classList.add('meta-list');

      for (let i = 0; i < metaEntries.length; i++) {
        const [ key, value ] = metaEntries[i];
        const item = document.createElement('div');
        item.classList.add('meta-item');

        const keyNode = document.createElement('div');
        keyNode.classList.add('meta-key');
        keyNode.innerText = key;
        item.appendChild(keyNode);

        const valWrapper = document.createElement('div');
        valWrapper.classList.add('meta-value');
        const isPriceFeed = key === 'Price Feed' && typeof value === 'string' && value.length;
        const displayValue = value === undefined || value === null || value === ''
          ? '—'
          : isPriceFeed
            ? truncateAddress(value)
            : value;
        valWrapper.innerText = displayValue;
        if (isPriceFeed) valWrapper.title = value;
        item.appendChild(valWrapper);

        if (key === 'Price Feed' && typeof value === 'string' && value.length) {
          const actions = document.createElement('div');
          actions.classList.add('meta-actions');
          actions.appendChild(createCopyButton(value));
          const explorerHref = blockscanOrigin ? blockscanOrigin + 'address/' + value : '';
          if (explorerHref) {
            actions.appendChild(createExplorerLink(explorerHref));
          }
          item.appendChild(actions);
        }

        container.appendChild(item);
      }

      return container;
    };

    const buildAssetCard = (contractName, contractValue, blockscanOrigin) => {
      const { address, explorerHref, meta } = normalizeContractEntry(contractValue, blockscanOrigin);
      const metaMap = new Map(meta);
      const getVal = (key) => metaMap.get(key);
      const getRaw = (key) => metaMap.get(key + ' Raw');

      const usedKeys = new Set(['Borrow CF', 'Liquidation CF', 'Liquidation Penalty', 'Supply Cap', 'Price Feed']);

      const card = document.createElement('div');
      card.classList.add('asset-card');

      const header = document.createElement('div');
      header.classList.add('card-header');

      const left = document.createElement('div');
      left.classList.add('left');

      const title = document.createElement('div');
      title.classList.add('asset-title');
      const nameEl = document.createElement('div');
      nameEl.classList.add('asset-name');
      nameEl.innerText = contractName;
      const addrEl = document.createElement('div');
      addrEl.classList.add('asset-address');
      addrEl.innerText = address ? truncateAddress(address) : 'Address: N/A';
      title.appendChild(nameEl);
      title.appendChild(addrEl);
      left.appendChild(title);

      const actions = document.createElement('div');
      actions.classList.add('card-actions');
      if (address) actions.appendChild(createCopyButton(address));
      if (explorerHref) actions.appendChild(createExplorerLink(explorerHref));

      header.appendChild(left);
      header.appendChild(actions);
      card.appendChild(header);

      const metrics = document.createElement('div');
      metrics.classList.add('metric-grid');
      metrics.appendChild(buildMetric('Borrow CF', getVal('Borrow CF'), getRaw('Borrow CF'), true));
      metrics.appendChild(buildMetric('Liquidation CF', getVal('Liquidation CF'), getRaw('Liquidation CF'), true));
      metrics.appendChild(buildMetric('Liquidation Penalty', getVal('Liquidation Penalty'), getRaw('Liquidation Penalty'), true));
      metrics.appendChild(buildMetric('Supply Cap', getVal('Supply Cap'), getRaw('Supply Cap'), false));
      card.appendChild(metrics);

      const remainingMeta = meta.filter(([ key ]) => {
        if (key.endsWith(' Raw')) return false;
        if (usedKeys.has(key)) return false;
        return true;
      });

      const priceFeed = getVal('Price Feed');
      if (priceFeed !== undefined && priceFeed !== null) {
        remainingMeta.unshift(['Price Feed', priceFeed]);
      }

      const metaList = buildMetaList(remainingMeta, blockscanOrigin);
      if (metaList) card.appendChild(metaList);

      return card;
    };

    const buildProtocolCard = (entries, blockscanOrigin) => {
      if (!entries.length) return null;
      const card = document.createElement('div');
      card.classList.add('protocol-card');
      const title = document.createElement('h5');
      title.innerText = 'Protocol Contracts';
      card.appendChild(title);

      const list = document.createElement('div');
      list.classList.add('protocol-list');

      for (let i = 0; i < entries.length; i++) {
        const [ name, address ] = entries[i];
        const item = document.createElement('div');
        item.classList.add('protocol-item');

        const info = document.createElement('div');
        const nameEl = document.createElement('div');
        nameEl.classList.add('name');
        nameEl.innerText = name;
        const addrEl = document.createElement('div');
        addrEl.classList.add('addr');
        addrEl.innerText = address ? truncateAddress(address) : 'N/A';
        info.appendChild(nameEl);
        info.appendChild(addrEl);

        const actions = document.createElement('div');
        actions.classList.add('actions');
        if (address) actions.appendChild(createCopyButton(address));
        if (address && blockscanOrigin) actions.appendChild(createExplorerLink(blockscanOrigin + 'address/' + address));

        item.appendChild(info);
        item.appendChild(actions);
        list.appendChild(item);
      }

      card.appendChild(list);
      return card;
    };

    for (let i = 0; i < deployments.length; i++) {
      const deploymentName = deployments[i];
      const contracts = Object.entries(deploymentsObject[deploymentName].contracts || {});
      const blockscanOrigin = deploymentsObject[deploymentName].blockscan_origin;
      const tabText = deploymentsObject[deploymentName].tab_text || deploymentName;

      const tabButton = document.createElement('div');
      tabButton.classList.add('network-tab-button');
      tabButton.id = 'network-tab-button-' + i;
      tabButton.dataset.index = i;
      tabButton.innerText = tabText;
      tabButton.addEventListener('click', _ => tabClickHandler(+_.target.dataset.index));
      networkTabs.appendChild(tabButton);

      const networkTab = document.createElement('div');
      networkTab.classList.add('network-tab-content');
      networkTab.id = 'network-tab-' + i;
      networkTab.dataset.index = i;

      const header = document.createElement('h4');
      header.innerText = deploymentName;
      networkTab.appendChild(header);

      const assetEntries = [];
      const protocolEntries = [];
      for (let j = 0; j < contracts.length; j++) {
        const [ name, value ] = contracts[j];
        if (value && typeof value === 'object' && Object.prototype.hasOwnProperty.call(value, 'address')) {
          assetEntries.push([ name, value ]);
        } else {
          protocolEntries.push([ name, value ]);
        }
      }

      if (protocolEntries.length) {
        const protoCard = buildProtocolCard(protocolEntries, blockscanOrigin);
        if (protoCard) networkTab.appendChild(protoCard);
      }

      if (assetEntries.length) {
        const cards = document.createElement('div');
        cards.classList.add('card-layout');
        for (let j = 0; j < assetEntries.length; j++) {
          const [ name, value ] = assetEntries[j];
          cards.appendChild(buildAssetCard(name, value, blockscanOrigin));
        }
        networkTab.appendChild(cards);
      }

      networkTabContainer.appendChild(networkTab);
    }

    networksWidget.appendChild(networkTabContainer);
    networksWidget.prepend(networkTabs);
    deploymentsContainer.appendChild(networksWidget);
    tabClickHandler(0);

    /* Copy buttons */
    const copyButtons = document.getElementsByClassName('copy-button');
    for (let i = 0; i < copyButtons.length; i++) {
      copyButtons[i].addEventListener('click', (ev) => {
        ev.stopPropagation();
        navigator.clipboard.writeText(copyButtons[i].dataset.copyText || '');
      });
    }
  });
</script>
